<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Continuum Nostr Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem;

      /* Base color + subtle watermark */
      background-color: #f9fafb;
      background-image: url("/images/A_minimalist_digital_image_displays_an_infinity_sy.png");
      background-repeat: repeat;
      background-size: 180px 180px; /* adjust density */
      background-attachment: fixed;

      color: #111827;
      line-height: 1.5;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1.25rem;
    }
    #status {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 1rem;
    }
    .filters {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .filters label {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .filters input {
      font-size: 0.9rem;
      padding: 0.15rem 0.3rem;
      border-radius: 0.25rem;
      border: 1px solid #d1d5db;
    }
    .filters button {
      font-size: 0.85rem;
      padding: 0.2rem 0.6rem;
      border-radius: 0.25rem;
      border: none;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
    }
    .filters button:hover {
      background: #d1d5db;
    }

    .npub-section {
      margin-bottom: 2rem;
      padding: 1.25rem;
      border-radius: 0.75rem;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .npub-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .npub-header .npub-label {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }
    .npub-header .npub-value {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: right;
      max-width: 60%;
      word-break: break-all;
    }
    .year-header {
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #4b5563;
    }

    .event-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .event-item {
      padding: 0.4rem 0;
      border-top: 1px solid #e5e7eb;
    }
    .event-item:first-of-type {
      border-top: none;
    }
    .event-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    .title-link {
      font-size: 0.95rem;
      color: #1d4ed8;
      text-decoration: none;
    }
    .title-link:hover {
      text-decoration: underline;
    }
    .event-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.1rem;
    }
    .summary {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 0.2rem;
    }
    .event-versions {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }

    .event-versions summary {
      cursor: pointer;
      list-style: none;
    }

    .event-versions summary::-webkit-details-marker {
      display: none;
    }

    .event-versions summary::before {
      content: "▾ ";
      font-size: 0.7rem;
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .badge.free {
      background: #dcfce7;
      color: #166534;
    }
    .badge.paid {
      background: #fee2e2;
      color: #b91c1c;
    }
  </style>
</head>

<body>
  <h1>Continuum Nostr Library</h1>
  <div class="subtitle">Articles and long-form events archived by npub and year.</div>

  <div class="filters">
    <label for="npub-filter">Filter by npub:</label>
    <input id="npub-filter" type="text" placeholder="Paste npub..." />
    <button id="apply-filter">Apply</button>
    <button id="clear-filter">Clear</button>
  </div>

  <div id="status">Loading index…</div>
  <div id="container"></div>

  <script>

    function isPaid(item) {
      // trust explicit paid flag if present:
      if (item.paid === true) return true;

      // fallback detection based on title/slug conventions
      if (item.title && item.title.includes("Paid Article")) return true;
      if (item.slug && item.slug.includes("paid")) return true;

      return false;
    }

    function formatDate(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      const year = d.getUTCFullYear();
      const month = String(d.getUTCMonth() + 1).padStart(2, "0");
      const day = String(d.getUTCDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function getYear(ts) {
      if (!ts) return "Unknown";
      return new Date(ts * 1000).getUTCFullYear();
    }

    function shortNpub(npub) {
      if (!npub || npub.length <= 18) return npub || "";
      return npub.slice(0, 12) + "…" + npub.slice(-6);
    }

    async function loadIndex() {
      const statusEl = document.getElementById("status");
      const container = document.getElementById("container");

      try {
        const res = await fetch("index.json", { cache: "no-cache" });
        if (!res.ok) {
          throw new Error("Unable to load index.json");
        }
        const items = await res.json();
        if (!Array.isArray(items) || items.length === 0) {
          statusEl.textContent = "No events found in the archive.";
          return;
        }

        // Check for npub filter in query params
        const urlParams = new URLSearchParams(window.location.search);
        const filterNpub = urlParams.get("npub");
        let filteredItems = items;

        if (filterNpub) {
          filteredItems = items.filter(item => item.npub === filterNpub);
          if (!filteredItems.length) {
            statusEl.textContent = "No events found in the archive for this npub.";
            container.innerHTML = "";
            return;
          }
        }

        // Group by (npub, slug) to collapse multiple versions of the same article
        const slugGroups = {};
        for (const item of filteredItems) {
          const slugKey = (item.npub || "unknown") + "::" + (item.slug || item.event_id);
          if (!slugGroups[slugKey]) slugGroups[slugKey] = [];
          slugGroups[slugKey].push(item);
        }

        // For each (npub, slug) group, sort by created_at desc and keep track of all versions
        const dedupedItems = [];
        for (const key in slugGroups) {
          const group = slugGroups[key].sort(
            (a, b) => (b.created_at || 0) - (a.created_at || 0)
          );
          dedupedItems.push({
            latest: group[0],
            versions: group
          });
        }

        // Group by npub, then by year, with sorting
        const byNpub = {};

        for (const entry of dedupedItems) {
          const item = entry.latest;
          const npub = item.npub || "unknown";
          const year = getYear(item.created_at);

          if (!byNpub[npub]) {
            byNpub[npub] = { npub, years: {} };
          }
          if (!byNpub[npub].years[year]) {
            byNpub[npub].years[year] = [];
          }
          byNpub[npub].years[year].push(entry);
        }

        // Sort npubs (alphabetical)
        const npubKeys = Object.keys(byNpub).sort();

        container.innerHTML = "";

        for (const npub of npubKeys) {
          const npubGroup = byNpub[npub];
          const npubSection = document.createElement("div");
          npubSection.className = "npub-section";

          // npub header
          const header = document.createElement("div");
          header.className = "npub-header";

          const titleSpan = document.createElement("div");
          titleSpan.className = "npub-label";
          titleSpan.textContent = "npub";

          const valueSpan = document.createElement("div");
          valueSpan.className = "npub-value";
          valueSpan.textContent = npub;

          header.appendChild(titleSpan);
          header.appendChild(valueSpan);
          npubSection.appendChild(header);

          // Sort years descending (2026, 2025, 2024, etc.)
          const yearKeys = Object.keys(npubGroup.years).sort((a, b) => Number(b) - Number(a));

          for (const year of yearKeys) {
            const yearHeader = document.createElement("div");
            yearHeader.className = "year-header";
            yearHeader.textContent = year;
            npubSection.appendChild(yearHeader);

            const list = document.createElement("ul");
            list.className = "event-list";

            // Sort events within year by created_at of latest version, descending
            const events = npubGroup.years[year].slice().sort(
              (a, b) => ((b.latest.created_at || 0) - (a.latest.created_at || 0))
            );

            for (const entry of events) {
              const item = entry.latest;

              const li = document.createElement("li");
              li.className = "event-item";

              const titleRow = document.createElement("div");
              titleRow.className = "event-title-row";

              const link = document.createElement("a");
              link.className = "title-link";
              link.href = `./?event_id=${encodeURIComponent(item.event_id)}`;
              link.textContent = item.title || item.slug || "(Untitled)";

              item.paid = isPaid(item);
              
              const badge = document.createElement("span");
              badge.className = "badge " + (item.paid ? "paid" : "free");
              badge.textContent = item.paid ? "Paid" : "Free";

              titleRow.appendChild(link);
              titleRow.appendChild(badge);
              li.appendChild(titleRow);

              // If there are multiple versions for this slug, show a collapsible list
              if (entry.versions && entry.versions.length > 1) {
                const details = document.createElement("details");
                details.className = "event-versions";

                const summary = document.createElement("summary");
                summary.textContent = `Versions (${entry.versions.length})`;
                details.appendChild(summary);

                const ul = document.createElement("ul");
                ul.style.margin = "0.25rem 0 0 0.5rem";
                ul.style.padding = "0";

                entry.versions.forEach(v => {
                  const li2 = document.createElement("li");
                  li2.style.listStyle = "none";

                  const a2 = document.createElement("a");
                  a2.href = `./?event_id=${encodeURIComponent(v.event_id)}`;
                  const vDate = v.created_at ? formatDate(v.created_at) : "";
                  a2.textContent = `${vDate} • kind: ${v.kind} • ${v.event_id.slice(0, 6)}…`;

                  li2.appendChild(a2);
                  ul.appendChild(li2);
                });

                details.appendChild(ul);
                li.appendChild(details);
              }

              const meta = document.createElement("div");
              meta.className = "event-meta";
              const metaParts = [];
              if (item.created_at) metaParts.push(formatDate(item.created_at));
              if (item.kind != null) metaParts.push("kind: " + item.kind);
              if (item.npub) metaParts.push(shortNpub(item.npub));
              meta.textContent = metaParts.join(" • ");
              li.appendChild(meta);

              if (item.summary) {
                const summary = document.createElement("div");
                summary.className = "summary";
                summary.textContent = item.summary;
                li.appendChild(summary);
              }

              list.appendChild(li);
            }

            npubSection.appendChild(list);
          }

          container.appendChild(npubSection);
        }

        statusEl.textContent = `Loaded ${dedupedItems.length} event(s) from ${npubKeys.length} npub(s).`;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading events.";
      }
    }

    loadIndex();

    // simple npub filter controls
    const filterInput = document.getElementById("npub-filter");
    const applyBtn = document.getElementById("apply-filter");
    const clearBtn = document.getElementById("clear-filter");

    applyBtn.addEventListener("click", () => {
      const npub = filterInput.value.trim();
      const params = new URLSearchParams(window.location.search);
      if (npub) {
        params.set("npub", npub);
      } else {
        params.delete("npub");
      }
      window.location.search = params.toString();
    });

    clearBtn.addEventListener("click", () => {
      filterInput.value = "";
      const params = new URLSearchParams(window.location.search);
      params.delete("npub");
      window.location.search = params.toString();
    });
  </script>
</body>
</html>
