<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Continuum Nostr Event Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      line-height: 1.6;

      /* Continuum watermark background */
      background-color: #f9fafb;
      background-image: url("/images/A_minimalist_digital_image_displays_an_infinity_sy.png");
      background-repeat: repeat;
      background-size: 180px 180px;  /* adjust tile density if needed */
      background-attachment: fixed;

      color: #111;
    }

    .content-container {
      background: #ffffff;
      padding: 2rem;
      margin: 1.5rem auto;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    h1 { margin-bottom: 0.2rem; }

    .meta {
      font-size: 0.9rem;
      color:#555;
      margin-bottom: 0.5rem;
      white-space: pre-line; /* lets the \n show as a second line */
    }

    .summary {
      background:#eef2ff;
      padding:0.75rem 1rem;
      border-radius:0.5rem;
      margin-bottom:1rem;
    }

    .links {
      background:#f3f4f6;
      padding:0.75rem 1rem;
      border-radius:0.5rem;
      margin-bottom:1rem;
      font-size:0.9rem;
    }
    .links a {
      display:inline-block;
      margin-right:1rem;
      margin-bottom:0.3rem;
      color:#2563eb;
      text-decoration:none;
    }
    .links a:hover { text-decoration:underline; }

    pre {
      background:#111;
      color:#eee;
      padding:1rem;
      border-radius:0.5rem;
      font-size:0.85rem;
      overflow-x:auto;
    }

    #header-image img {
      max-width: 100%;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      display: block;
    }

    .tags {
      margin: 0.5rem 0 1rem 0;
      font-size: 0.9rem;
      color: #444;
    }
    .tags span {
      background: #eee;
      padding: 3px 8px;
      margin-right: 6px;
      margin-bottom: 6px;
      border-radius: 6px;
      display: inline-block;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div class="content-container">
    <h1 id="title">Loading…</h1>

    <div class="meta" id="meta"></div>

    <div class="summary" id="summary" style="display:none;"></div>

    <div id="paid-status" style="display:none; font-size:0.9rem; margin:0.5rem 0;"></div>
    
    <div id="tags" style="display:none;" class="tags"></div>

    <div class="links" id="links" style="display:none;"></div>

    <div id="header-image"></div>

    <div id="loading">Fetching event…</div>
    <div id="content"></div>
  </div>

<script>
  function getEventId() {
    const params = new URLSearchParams(window.location.search);
    return params.get("event_id");
  }

  function formatDate(ts) {
    if (!ts) return "";
    return new Date(ts * 1000).toISOString().slice(0, 10);
  }

  async function loadEvent() {
    const eventId = getEventId();
    if (!eventId) {
      window.location.href = "/404.html";
      return;
    }

    const titleEl = document.getElementById("title");
    const metaEl = document.getElementById("meta");
    const summaryEl = document.getElementById("summary");
    const linksEl = document.getElementById("links");
    const contentEl = document.getElementById("content");
    const tagsEl = document.getElementById("tags");
    const headerImageEl = document.getElementById("header-image");
    const loadingEl = document.getElementById("loading");

    try {
      const indexRes = await fetch("index.json", { cache: "no-cache" });
      const index = await indexRes.json();
      const entry = index.find(e => e.event_id === eventId);

      if (!entry) {
        window.location.href = "/404.html";
        return;
      }

      // Load event JSON
      const jsonUrl = entry.json_url;
      const evRes = await fetch(jsonUrl, { cache: "no-cache" });
      const evJson = await evRes.json();

      loadingEl.style.display = "none";

      const tags = Array.isArray(evJson.tags) ? evJson.tags : [];
      const findTag = (name) => tags.find(t => t[0] === name);

      const displayDateTag = findTag("display_date");
      const imageTag = findTag("image");
      const displayDate = displayDateTag ? displayDateTag[1] : "";

      // Extract topic tags (no "#")
      const topicTags = tags
        .filter(t => t[0] === "t")
        .map(t => t[1])
        .filter(Boolean);

      // Title
      titleEl.textContent = entry.title || entry.slug || "Untitled";

      // Created & Published
      const createdDate = entry.created_at ? formatDate(entry.created_at) : "";
      const publishedDate = displayDate || createdDate;

      // Meta: line 1 (created/published) + line 2 (npub)
      metaEl.textContent =
        `Created: ${createdDate} • Published: ${publishedDate}\n` +
        (entry.npub ? `npub: ${entry.npub}` : "");

      // Summary
      if (entry.summary) {
        summaryEl.style.display = "block";
        summaryEl.textContent = entry.summary;
      }

      // Tag pills
      if (topicTags.length) {
        tagsEl.style.display = "block";
        tagsEl.innerHTML = topicTags
          .map(tag => `<span>${tag}</span>`)
          .join(" ");
      }

      // Links
      const base = jsonUrl.replace(/\.json$/i, "");
      const mdUrl = base + ".md";
      const pdfUrl = base + ".pdf";

      linksEl.innerHTML = `
        <a href="${jsonUrl}" target="_blank">Raw JSON</a>
        <a href="${mdUrl}" target="_blank">Markdown (if exists)</a>
        <a href="${pdfUrl}" target="_blank">PDF (if exists)</a>
        <a href="https://primal.net/e/${eventId}" target="_blank">Primal</a>
        <a href="https://coracle.social/notes/${eventId}" target="_blank">Coracle</a>
        <a href="https://phoenix.social/e/${eventId}" target="_blank">Phoenix</a>
        <a href="https://njump.me/${eventId}" target="_blank">njump</a>
      `;
      linksEl.style.display = "block";

      // Header image
      if (imageTag && imageTag[1]) {
        const img = document.createElement("img");
        img.src = imageTag[1];
        img.alt = entry.title || entry.slug;
        headerImageEl.innerHTML = "";
        headerImageEl.appendChild(img);
      }

      // Markdown → HTML
      const raw = evJson.content || "";
      let html = "";
      try {
        html = marked.parse(raw);
      } catch { html = ""; }

      if (html.trim()) {
        contentEl.innerHTML = html;
      } else {
        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(evJson, null, 2);
        contentEl.appendChild(pre);
      }

    } catch (err) {
      console.error(err);
      window.location.href = "/404.html";
    }
  }

  loadEvent();
</script>

</body>
</html>
