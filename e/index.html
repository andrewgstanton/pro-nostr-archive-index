<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Continuum Nostr Event Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      line-height: 1.6;
      background: #f9fafb;
      color: #111;
    }
    h1 { margin-bottom: 0.2rem; }
    .meta { font-size: 0.9rem; color:#666; margin-bottom: 1rem; }
    .summary {
      background:#eef2ff;
      padding:0.75rem 1rem;
      border-radius:0.5rem;
      margin-bottom:1rem;
    }
    .links {
      background:#f3f4f6;
      padding:0.75rem 1rem;
      border-radius:0.5rem;
      margin-bottom:1rem;
      font-size:0.9rem;
    }
    .links a {
      display:inline-block;
      margin-right:1rem;
      margin-bottom:0.3rem;
      color:#2563eb;
      text-decoration:none;
    }
    .links a:hover { text-decoration:underline; }
    pre {
      background:#111;
      color:#eee;
      padding:1rem;
      border-radius:0.5rem;
      font-size:0.85rem;
      overflow-x:auto;
    }
    .error { color:#b91c1c; font-weight:600; margin-top:1rem; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <h1 id="title">Loading…</h1>
  <div class="meta" id="meta"></div>
  <div class="summary" id="summary" style="display:none;"></div>
  <div class="links" id="links" style="display:none;"></div>

  <div id="loading">Fetching event…</div>
  <div id="content"></div>

  <script>
    function getEventId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("event_id");
    }

    function formatDate(ts) {
      if (!ts) return "";
      return new Date(ts * 1000).toISOString().slice(0, 10);
    }

    async function loadEvent() {
      const eventId = getEventId();
      if (!eventId) {
        window.location.href = "/404.html";
        return;
      }

      const titleEl = document.getElementById("title");
      const metaEl = document.getElementById("meta");
      const summaryEl = document.getElementById("summary");
      const linksEl = document.getElementById("links");
      const loadingEl = document.getElementById("loading");
      const contentEl = document.getElementById("content");

      try {
        const indexRes = await fetch("index.json", { cache: "no-cache" });
        const index = await indexRes.json();
        const entry = index.find(e => e.event_id === eventId);

        if (!entry) {
          window.location.href = "/404.html";
          return;
        }

        // Header
        titleEl.textContent = entry.title || entry.slug;
        metaEl.textContent = [
          entry.created_at ? `Published: ${formatDate(entry.created_at)}` : "",
          entry.npub ? `npub: ${entry.npub}` : "",
          entry.kind ? `kind: ${entry.kind}` : ""
        ].filter(Boolean).join(" • ");

        // Summary
        if (entry.summary) {
          summaryEl.style.display = "block";
          summaryEl.textContent = entry.summary;
        }

        // Links
        const jsonUrl = entry.json_url;
        const base = jsonUrl.replace(/\.json$/i, "");
        const mdUrl = base + ".md";
        const pdfUrl = base + ".pdf";

        linksEl.innerHTML = `
          <a href="${jsonUrl}" target="_blank">Raw JSON</a>
          <a href="${mdUrl}" target="_blank">Markdown (if exists)</a>
          <a href="${pdfUrl}" target="_blank">PDF (if exists)</a>
          <a href="https://primal.net/e/${eventId}" target="_blank">Primal</a>
          <a href="https://coracle.social/notes/${eventId}" target="_blank">Coracle</a>
          <a href="https://phoenix.social/e/${eventId}" target="_blank">Phoenix</a>
          <a href="https://njump.me/${eventId}" target="_blank">njump</a>
        `;
        linksEl.style.display = "block";

        // Load JSON for event
        const evRes = await fetch(jsonUrl, { cache: "no-cache" });
        const evJson = await evRes.json();

        loadingEl.style.display = "none";

        // Render Markdown if present
        const raw = evJson.content || "";
        let html = "";
        try {
          html = marked.parse(raw);
        } catch {
          html = "";
        }

        if (html.trim()) {
          contentEl.innerHTML = html;
        } else {
          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify(evJson, null, 2);
          contentEl.appendChild(pre);
        }

      } catch (err) {
        console.error(err);
        window.location.href = "/404.html";
      }
    }

    loadEvent();
  </script>
</body>
</html>
